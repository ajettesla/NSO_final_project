#!/bin/bash

# Source the OpenStack credentials
source /opt/openrc_file

# Define the floating IP
FLOATING_IP={{ floatingIp.haproxy }}  # Ensure this is interpolated correctly

# Get the action (master or backup)
ACTION=$1

# Define instance IDs
MASTER_INSTANCE_ID="proxy_1"
BACKUP_INSTANCE_ID="proxy_2"

# Perform actions based on the VRRP state
if [ "$ACTION" == "master" ]; then
    echo "Switching to MASTER"
    
    # Remove floating IP from the backup instance first
    openstack server remove floating ip "$BACKUP_INSTANCE_ID" "$FLOATING_IP"
    if [ $? -eq 0 ]; then
        echo "Successfully removed floating IP $FLOATING_IP from $BACKUP_INSTANCE_ID"
    else
        echo "Failed to remove floating IP $FLOATING_IP from $BACKUP_INSTANCE_ID" >&2
        exit 1
    fi

    # Assign floating IP to the master instance
    openstack server add floating ip "$MASTER_INSTANCE_ID" "$FLOATING_IP"
    if [ $? -eq 0 ]; then
        echo "Successfully assigned floating IP $FLOATING_IP to $MASTER_INSTANCE_ID"
    else
        echo "Failed to assign floating IP $FLOATING_IP to $MASTER_INSTANCE_ID" >&2
        exit 1
    fi

elif [ "$ACTION" == "backup" ]; then
    echo "Switching to BACKUP"

    # Remove floating IP from the master instance first
    openstack server remove floating ip "$MASTER_INSTANCE_ID" "$FLOATING_IP"
    if [ $? -eq 0 ]; then
        echo "Successfully removed floating IP $FLOATING_IP from $MASTER_INSTANCE_ID"
    else
        echo "Failed to remove floating IP $FLOATING_IP from $MASTER_INSTANCE_ID" >&2
        exit 1
    fi

    # Assign floating IP to the backup instance
    openstack server add floating ip "$BACKUP_INSTANCE_ID" "$FLOATING_IP"
    if [ $? -eq 0 ]; then
        echo "Successfully assigned floating IP $FLOATING_IP to $BACKUP_INSTANCE_ID"
    else
        echo "Failed to assign floating IP $FLOATING_IP to $BACKUP_INSTANCE_ID" >&2
        exit 1
    fi
else
    echo "Unknown action $ACTION"
    exit 1
fi

exit 0
